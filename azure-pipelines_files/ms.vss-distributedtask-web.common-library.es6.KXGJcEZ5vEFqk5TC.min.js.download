"use strict";define("DistributedTask/Common/Library",["require","exports","VSS/Core/Observable","VSS/Platform/Context","VSS/Platform/Feature","react","VSS/Platform/Layout","VSSUI/ComboBox","VSSUI/Link","VSSUI/PickList","VSSUI/Spinner","DistributedTask/Client/RestClient/TaskAgent"],function(e,t,i,n,s,o,r,a,c,p,u,g){var l,d;l=t.Resources={},Object.defineProperty(t,"__esModule",{value:!0}),t.Resources.AgentSpecificationLabel="Agent Specification",t.Resources.QueueOptionHeaderHosted="Hosted",t.Resources.QueueOptionHeaderPrivate="Private",t.Resources.ErrorFetchingAgentSpecifications="An unexpected error occured while retrieving agent specifications. You may need to refresh your page and try again.",t.Resources.OptionAffectsDataStorageAndSecurity="This option affects your data storage and security.",t.Resources.LearnMore="Learn More",function(e){t.SourcesAgentSpecificationService={},Object.defineProperty(t,"__esModule",{value:!0});class o extends n.VssService{_serviceStart(e){super._serviceStart(e),this._agentSpecifications=new i.ObservableArray,this._lastServiceError=new i.ObservableValue("")}async getAgentSpecificationsByQueue(e){if(!s.isFeatureFlagEnabled(this.pageContext,"WebAccess.Build.CIWorkflow.AgentDefinition",!1))return Promise.resolve([]);if(!e||!e.pool||!e.pool.isHosted||e.pool.name!==o.AZURE_PIPELINES)return Promise.resolve([]);const t={queueId:e.id};return this.pageContext.getService("IVssContributionService").getDataAsync("ms.vss-build-web.agent-definitions-data-provider",t,!0).then(e=>e||[])}}t.SourcesAgentSpecificationService.AgentSpecificationService=o,o.AZURE_PIPELINES="Azure Pipelines",n.Services.add("IAgentSpecificationService",{serviceFactory:o})}(),function(e){d=t.AgentSpecificationDropdown={},Object.defineProperty(t,"__esModule",{value:!0});t.AgentSpecificationDropdown.AgentSpecificationDropdown=class extends r.VssComponent{constructor(e,t){super(e,t),this._getAgentSpecificationOption=(e=>o.createElement("span",{className:"agent-specification-option"},e.text)),this._onChanged=(e=>{this.props.onChanged&&e&&e.item&&this.props.onChanged(e.item)}),this.state={isEnabled:this._isEnabled(t)}}render(){if(!this.state.isEnabled)return null;const e=this._getOptions();if(0===e.length&&!this.props.errorMessage)return null;const t=this.props.selectedAgentSpecification?this.props.selectedAgentSpecification.identifier:"",i={options:e,disabled:this.props.disabled,label:l.AgentSpecificationLabel,errorMessage:this.props.errorMessage,onChanged:this._onChanged,allowFreeform:!1,onRenderOption:this._getAgentSpecificationOption,selectedKey:t,required:!0};return o.createElement("div",{className:"agent-specification-dropdown"},o.createElement(a.ComboBox,Object.assign({},i)),this._isMacAgentSpecificationSelected()&&o.createElement("div",{className:"agent-specification-message"},o.createElement("span",{className:"agent-specification-message"},l.OptionAffectsDataStorageAndSecurity),o.createElement(c.Link,{href:"https://go.microsoft.com/fwlink/?linkid=870426",target:"_blank",rel:"noopener noreferrer"},l.LearnMore)))}_isMacAgentSpecificationSelected(){const e=this.props.selectedAgentSpecification;return!!(e&&e.identifier&&e.identifier.indexOf("macOS")>-1)}_isEnabled(e){if(!e.pageContext||!e.pageContext.getService)return!1;const t=e.pageContext.getService("IVssPageService").getData();return!!(t&&t.isHosted&&e.pageContext)&&s.isFeatureFlagEnabled(e.pageContext,"WebAccess.Build.CIWorkflow.AgentDefinition",!1)}_getOptions(){let e=[];if(this.props.agentSpecifications&&this.props.agentSpecifications.length>0&&(e=this.props.agentSpecifications.map(e=>({key:e.identifier,text:e.identifier,item:e}))),this.props.selectedAgentSpecification&&this.props.selectedAgentSpecification.identifier){const t=this.props.selectedAgentSpecification;e.some(e=>e.key===t.identifier)||e.push({key:t.identifier,text:t.identifier,item:t})}return e}}}(),function(e){var i;t.AgentQueueSelector={},Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.Hosted="1",e.Private="2"}(i||(i={}));t.AgentQueueSelector.AgentQueueSelector=class extends o.PureComponent{constructor(){super(...arguments),this._agentQueuePickListRef=o.createRef(),this._getListItem=(e=>{let t=i.Private;return e.pool&&e.pool.isHosted&&(t=i.Hosted),{name:e.name,key:e.id.toString(),groupKey:t}}),this._onAgentChanged=(e=>{const t=e.selectedItems;let i={};t&&t.length>0&&this.props.agentQueues.some(e=>e.id===t[0].id&&(i=e,!0)),this.props.onAgentChanged&&this.props.onAgentChanged(i)}),this._getAgentQueues=(()=>this.props.agentQueues),this._handleAgentSpecificationChanged=(e=>{this.props.onAgentSpecificationSelected(e)})}render(){const e=`${this.props.label} {0}`;return o.createElement("div",{className:"flex-column label"},o.createElement("label",{className:"label"},this.props.label),o.createElement(p.PickListDropdown,{ariaLabelFormat:e,className:"agent-pool-container",selectOnFocus:!0,selectedItems:[this.props.selectedQueue||{}],getPickListItems:this._getAgentQueues,onSelectionChanged:this._onAgentChanged,getListItem:this._getListItem,ref:this._agentQueuePickListRef,groups:[{name:l.QueueOptionHeaderHosted,key:i.Hosted},{name:l.QueueOptionHeaderPrivate,key:i.Private}]}),this.props.isLoadingAgentSpecifications?o.createElement(u.Spinner,{className:"queue-build-spinner"}):o.createElement(d.AgentSpecificationDropdown,{agentQueue:this.props.selectedQueue,agentSpecifications:this.props.agentSpecifications,selectedAgentSpecification:this.props.selectedAgentSpecification,errorMessage:this.props.agentSpecificationErrorMessage,onChanged:this._handleAgentSpecificationChanged}))}componentDidMount(){this.props.autoFocus&&this._agentQueuePickListRef&&this._agentQueuePickListRef.current&&this._agentQueuePickListRef.current.focus()}}}(),function(e){t.SourcesQueue={},Object.defineProperty(t,"__esModule",{value:!0});t.SourcesQueue.QueueSource=class{constructor(e){this._client=g.getTaskAgentClient(e.pageContext),this._project=e.project}getQueues(){return this._getQueues({project:this._project})}_getQueues(e){return this._client.getAgentQueues(e.project||this._project,e.queueName||void 0,e.actionFilter||16).then(e=>this._sortQueues(e||[]))}_sortQueues(e){return(e||[]).sort((e,t)=>e.name>t.name?1:e.name<t.name?-1:0)}}}()},["Resources","Sources/AgentSpecificationService","AgentSpecificationDropdown","AgentQueueSelector","Sources/Queue"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-distributedtask-web.common-library"}}));