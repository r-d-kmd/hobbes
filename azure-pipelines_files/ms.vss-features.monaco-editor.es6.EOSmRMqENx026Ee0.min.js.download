"use strict";define("VSS/Features/Monaco",["require","exports","VSS/Platform/Context","react","VSS/Core/Observable","VSS/Platform/Layout","VSS/Platform/Util/Url","VSSUI/Util"],function(e,t,o,s,i,n,r,d){var a,c,h;a=t.Resources={},Object.defineProperty(t,"__esModule",{value:!0}),t.Resources.EscapeToLoseFocus="Lose Editor Focus",function(e){function s(e){if(null==e)return e;if(e instanceof Array)return e.map(s);if("object"==typeof e){if("string"==typeof e._regex)return new RegExp(e._regex,"string"==typeof e._flags?e._flags:void 0);for(const t in e)e[t]=s(e[t])}return e}c=t.Languages={},Object.defineProperty(t,"__esModule",{value:!0});const i="ms.vss-features.code-editor-language",n="ms.vss-features.code-editor-json-schema",r="ms.vss-features.code-editor-json-schema-provider";o.Services.add("IMonacoLanguageExtensionService",{serviceFactory:class extends o.VssService{constructor(){super(...arguments),this.registeredContributionIds=new Set,this.resourceChangedCallbacks=[]}registerLanguages(){const e=this.pageContext.getService("IVssContributionService").getContributionsByType(i);for(const t in e)this.registeredContributionIds.has(t)||(this.registeredContributionIds.add(t),this.registerLanguage(t,e[t]))}registerJsonSchemas(){const e=this.pageContext.getService("IVssContributionService"),t=e.getContributionsByType(n);for(const e in t)this.registeredContributionIds.has(e)||(this.registeredContributionIds.add(e),this.registerJsonSchema(e,t[e]));const o=e.getContributionsByType(r);for(const e in o)this.registeredContributionIds.has(e)||(this.registeredContributionIds.add(e),this.loadDynamicSchemaProvider(e))}registerLanguage(e,t){try{monaco.languages.register({id:e,aliases:t.aliases,extensions:t.extensions,filenamePatterns:t.filenamePatterns,filenames:t.filenames,firstLine:t.firstLine,mimetypes:t.mimetypes}),monaco.languages.onLanguage(e,()=>{t.configuration&&monaco.languages.setLanguageConfiguration(e,s(t.configuration)),t.language&&monaco.languages.setMonarchTokensProvider(e,s(t.language))})}catch(t){console.error(`Failed to register monaco language contribution "${e}". Exception: ${t&&t.message}`)}}registerJsonSchema(e,t){try{const o=monaco.languages.json.jsonDefaults;o.setDiagnosticsOptions(Object.assign(Object.assign({},o.diagnosticsOptions),{schemas:[...(o.diagnosticsOptions.schemas||[]).filter(e=>e.uri!==t.uri),t]}))}catch(t){console.error(`Failed to register json schema contribution "${e}". Exception: ${t&&t.message}`)}}async loadDynamicSchemaProvider(e){try{const t=this.pageContext.getService("IVssContributionService"),o=await t.getService(e);o&&o.register({getJsonSchemas:()=>monaco.languages.json.jsonDefaults.diagnosticsOptions.schemas||[],onResourceChanged:e=>{this.addResourceChangedCallback(e)},registerJsonSchemas:t=>{for(const o of t)this.registerJsonSchema(e,o)}})}catch(t){console.error(`Failed to load json schema provider "${e}". Exception: ${t&&t.message}`)}}addResourceChangedCallback(e){this.resourceChangedCallbacks.push(e),1===this.resourceChangedCallbacks.length&&(monaco.editor.onDidChangeModelLanguage(({model:e})=>this.triggerResourceChangedCallbacks(e)),monaco.editor.onDidCreateModel(e=>{this.triggerResourceChangedCallbacks(e),e.onDidChangeContent(()=>this.triggerResourceChangedCallbacks(e))}));for(const t of monaco.editor.getModels())this.triggerResourceChangedCallback(t,e)}triggerResourceChangedCallbacks(e){for(const t of this.resourceChangedCallbacks)this.triggerResourceChangedCallback(e,t)}triggerResourceChangedCallback(e,t){t({uri:e.uri.toString(),getContent:()=>e.getValue(),languageId:e.getModeId()})}}}),t.Languages.registerLanguageExtensions=function(e){const t=e.getService("IMonacoLanguageExtensionService");t.registerLanguages(),t.registerJsonSchemas()}}(),function(e){t.MonacoEnvironment={},Object.defineProperty(t,"__esModule",{value:!0});const s={css:"debug/css.worker.84c7c7b810aa23aba95b.js",default:"debug/editor.worker.0b5146c60ee42526ac7d.js",html:"debug/html.worker.26977ef42c0d6ba28ea8.js",json:"debug/json.worker.00dc157025039ed4110a.js",ts:"debug/ts.worker.951b1e549938413019a8.js"},i={css:"min/css.worker.ba5dd3e38d6d389690ed.js",default:"min/editor.worker.6da81e590cd144409502.js",html:"min/html.worker.81422f2db3398e8537e8.js",json:"min/json.worker.079b36d3ed0fc2ea9b6a.js",ts:"min/ts.worker.cb17ddcd0e4f41787698.js"},n=[{token:"debug-token",foreground:"9966FF"},{token:"error-token",foreground:"E92D3D"},{token:"info-token",foreground:"888888"},{token:"warn-token",foreground:"FF8C00"},{token:"command-token",foreground:"0078D4"},{token:"section-token",foreground:"1FAE3E"}],r=[{token:"comment",foreground:"007200"},{token:"number",foreground:"007200"},...n],d=[{token:"",foreground:"FFFFFF",background:"000000"},{token:"comment",foreground:"13A10E"},{token:"number",foreground:"13A10E"},...n],a=[...n];o.Services.add("IMonacoEnvironmentService",{serviceFactory:class extends o.VssService{constructor(){super(...arguments),this.definedThemes=new Set}setupMonacoEnvironment(){window.MonacoEnvironment||(window.MonacoEnvironment={getWorkerUrl:(e,t)=>{const o=this.pageContext.getService("IVssPageService").getData().isDebugMode?s:i;let n;return n="json"===t?o.json:"css"===t||"scss"===t?o.css:"html"===t?o.html:"typescript"===t||"javascript"===t?o.ts:o.default,window.__extensionsLocalStaticRoot+"ms.vss-features/monaco-editor/modules/vss-monaco-editor/dist/"+n}}),c.registerLanguageExtensions(this.pageContext)}defineEditorTheme(e){e=e||"vs",window.navigator.userAgent.toLowerCase().indexOf("edge")>=0&&window.matchMedia&&window.matchMedia("(-ms-high-contrast:active)").matches&&(e="vs");const t="tfs-extension-"+e;if(!this.definedThemes.has(t)){let o=[];"vs"===e?o=r:"vs-dark"===e?o=d:"hc-black"===e&&(o=a);const s={base:e,inherit:!0,rules:o,colors:{}};monaco.editor.defineTheme(t,s),this.definedThemes.add(t)}return t}}})}(),function(e){h=t.ComponentsEditorBase={},Object.defineProperty(t,"__esModule",{value:!0});const o={fontSize:12,lineNumbersMinChars:5};t.ComponentsEditorBase.EditorBase=class extends n.VssComponent{constructor(e,t){super(e,t),this.containerRef=s.createRef(),this.actionDisposables=[],this.widgetDisposables=[],this.isContentUserEdited=!1,this.isContentChangeFromProps=!1,this.throttledContentChangedTimeout=null,this.onThemeUpdated=(()=>{if(!this.props.monacoTheme){const e=this.getEditorTheme();monaco.editor.setTheme(e)}}),this.onWidgetsChange=(e=>{for(const t of e.removedItems||[]){const e=this.widgetDisposables.findIndex(e=>e.id===t.widgetId);e>=0&&this.widgetDisposables.splice(e,1).forEach(e=>e.dispose())}this.addEditorWidgets(this.editor,e.addedItems||[])}),this.onResize=(()=>{this.editor&&this.editor.layout()}),this.context.pageContext.getService("IMonacoEnvironmentService").setupMonacoEnvironment()}render(){return s.createElement("div",{ref:this.containerRef,className:d.css("vss-base-editor",this.props.className)})}componentDidMount(){if(super.componentDidMount(),this.containerRef.current){const e=this.getEditorOptions();this.editor=this.createEditor(this.containerRef.current,e);const t="function"==typeof this.props.actions?this.props.actions(this.editor)||[]:this.props.actions||[];this.props.elementToFocusOnEscape&&t.push({id:"vssf-escape",label:a.EscapeToLoseFocus,keybindings:[monaco.KeyCode.Escape],precondition:"!suggestWidgetVisible && !markersNavigationVisible && !parameterHintsVisible && !findWidgetVisible",run:e=>{const t=document.activeElement,o=this.props.elementToFocusOnEscape?document.querySelector(this.props.elementToFocusOnEscape):null;o&&o.focus&&!o.hasAttribute("disabled")&&!o.classList.contains("disabled")&&"hidden"!==o.style.visibility&&"none"!==o.style.display&&o.focus(),document.activeElement===t&&t&&t.blur&&t.blur()}}),this.addEditorActions(t),this.isContentChangeFromProps=!0,this.setEditorContent(this.editor),this.sendThrottledContentChangedEvent(),this.isContentChangeFromProps=!1;const o=this.props.widgets;o&&(this.addEditorWidgets(this.editor,i.ObservableLike.isObservable(o)?o.value:o),i.ObservableLike.subscribe(o,this.onWidgetsChange)),this.props.editorRef&&"function"==typeof this.props.editorRef&&this.props.editorRef(this.editor)}window.addEventListener("resize",this.onResize)}componentDidUpdate(e,t){if(super.componentDidUpdate(e,t),this.editor){if(this.props.lazyVisualContentChange||(this.isContentChangeFromProps=!0,this.updateEditorContent(this.editor),this.isContentChangeFromProps=!1),this.props.monacoTheme&&this.props.monacoTheme!==e.monacoTheme){const e=this.getEditorTheme();monaco.editor.setTheme(e)}this.editor.layout()}}componentWillUnmount(){super.componentWillUnmount(),this.containerRef.current&&(this.containerRef.current.innerHTML=""),this.actionDisposables.forEach(e=>e.dispose()),this.actionDisposables=[],this.widgetDisposables.forEach(e=>e.dispose()),this.widgetDisposables=[],i.ObservableLike.unsubscribe(this.props.widgets,this.onWidgetsChange),delete this.editor,window.removeEventListener("resize",this.onResize)}sendThrottledContentChangedEvent(){if(this.props.onContentUpdated)if(this.isContentChangeFromProps)this.isContentUserEdited=!1,this.props.onContentUpdated(this.editor);else{this.throttledContentChangedTimeout&&window.clearTimeout(this.throttledContentChangedTimeout);const e=this.isContentUserEdited?300:0;this.throttledContentChangedTimeout=window.setTimeout(()=>{this.isContentUserEdited=!0,this.editor&&this.props.onContentUpdated&&this.props.onContentUpdated(this.editor)},e)}}createEditorModel(e,t,o){let s,i;if(t)s=t;else if(o){-1===o.indexOf("://")&&(o=r.combineUrlPaths("inmemory://model",o)),i=monaco.Uri.parse(o);const t=monaco.editor.getModel(i);if(t){if(t.getValue()===e)return t;t.dispose()}}return monaco.editor.createModel(e,s,i)}addEditorWidgets(e,t){if(e){const o=e.getEditorType()===monaco.editor.EditorType.IDiffEditor,s=o?e:void 0,i=o?s.getModifiedEditor():e;for(const e of t){const t=e.addWidget(i,s);if(t&&this.widgetDisposables.push({dispose:()=>e.removeWidget(t,i,s),id:e.widgetId}),s){const t=s.getOriginalEditor(),o=e.addWidget(t,s);o&&this.widgetDisposables.push({dispose:()=>e.removeWidget(o,t,s),id:e.widgetId})}}}}getEditorOptions(){return Object.assign(Object.assign({scrollBeyondLastLine:!this.props.editorOptions||!this.props.editorOptions.readOnly,theme:this.getEditorTheme()},o),this.props.editorOptions)}getEditorTheme(){let e=this.props.monacoTheme;if(!e){const t=this.context.pageContext.getService("IVssThemeService");e=t.getCurrentTheme().isDark?"vs-dark":"vs",this.themeListenerAdded||(this.themeListenerAdded=!0,t.subscribe(this.onThemeUpdated),this.addUnmountCallback(()=>t.unsubscribe(this.onThemeUpdated)))}return this.context.pageContext.getService("IMonacoEnvironmentService").defineEditorTheme(e)}addEditorActions(e){if(this.editor){const t=this.editor.getEditorType()===monaco.editor.EditorType.IDiffEditor,o=t?this.editor:void 0,s=t?o.getModifiedEditor():this.editor;for(const i of e)this.actionDisposables.push(s.addAction(i)),t&&this.actionDisposables.push(o.getOriginalEditor().addAction(i))}}}}(),function(e){t.ComponentsDiffEditor={},Object.defineProperty(t,"__esModule",{value:!0});t.ComponentsDiffEditor.DiffEditor=class extends h.EditorBase{constructor(){super(...arguments),this.diffComputed=!1}setEditorContent(e){if(e&&void 0!==this.props.originalContent&&this.props.modifiedContent){const t=this.createEditorModel(this.props.modifiedContent.content,this.props.modifiedContent.contentType,this.props.modifiedContent.contentUri);e.setModel({original:this.createEditorModel(this.props.originalContent,t.getModeId(),void 0),modified:t}),e.setPosition({lineNumber:1,column:1}),e.layout()}}createEditor(e,t){const o=monaco.editor.createDiffEditor(e,t);return this.props.onContentUpdated&&o.getModifiedEditor().onDidChangeModelContent(()=>this.sendThrottledContentChangedEvent()),o}addEditorWidgets(e,t){e&&(this.diffComputed?super.addEditorWidgets(e,t):e.onDidUpdateDiff(()=>{this.diffComputed=!0,super.addEditorWidgets(e,t)}))}updateEditorContent(e){this.setEditorContent(e)}}}(),function(e){t.ComponentsEditor={},Object.defineProperty(t,"__esModule",{value:!0});class o extends h.EditorBase{setEditorContent(e){if(e&&this.props.content){const t=this.createEditorModel(this.props.content.content,this.props.content.contentType,this.props.content.contentUri);e.setModel(t),e.setPosition({lineNumber:1,column:1}),e.layout()}}createEditor(e,t){const o=monaco.editor.create(e,t);return this.props.onContentUpdated&&o.onDidChangeModelContent(()=>this.sendThrottledContentChangedEvent()),o}updateEditorContent(e){if(e&&this.props.content){const t=e.getModel();if(t){t.getValue()!==this.props.content.content&&t.setValue(this.props.content.content)}}}}t.ComponentsEditor.Editor=o,o.componentTypeName="code-editor",n.VssComponent.register(o.componentTypeName,o)}()},["Resources","Languages","MonacoEnvironment","Components/EditorBase","Components/DiffEditor","Components/Editor"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-features.monaco-editor"}}));